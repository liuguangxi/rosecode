/* x[n] = c[1]*x[n-1] + ... + c[k]*x[n-k] */
gen_lr(x_ini, c, n) = {
    my(sz = #x_ini, A, xn);
    if (n <= sz, return(x_ini[n]));
    A = matrix(sz);
    A[1,] = c;
    for (i = 2, sz, A[i,i-1] = 1);
    xn = A^(n-sz) * Vecrev(x_ini)~;
    return(xn[1]);
}

gen_lr_mod(x_ini, c, n, m) = {
    my(sz = #x_ini, A, xn);
    if (n <= sz, return(x_ini[n]));
    A = Mod(matrix(sz), m);
    A[1,] = Mod(c, m);
    for (i = 2, sz, A[i,i-1] = Mod(1, m));
    xn = A^(n-sz) * Mod(Vecrev(x_ini)~, m);
    return(xn[1]);
}


/*
count of numbers with number of digits = nd and sum of digits = sd
nd >= 1, 0 <= sd <= 10
*/
fc(nd, sd) = {
    my(x_ini, c);
    if (sd == 0, return(1));
    if (sd == 1, x_ini = [1, 2]; c = [2, -1]);
    if (sd == 2, x_ini = [1, 3, 6]; c = [3, -3, 1]);
    if (sd == 3, x_ini = [1, 4, 10, 20]; c = [4, -6, 4, -1]);
    if (sd == 4, x_ini = [1, 5, 15, 35, 70]; c = [5, -10, 10, -5, 1]);
    if (sd == 5, x_ini = [1, 6, 21, 56, 126, 252]; c = [6, -15, 20, -15, 6, -1]);
    if (sd == 6, x_ini = [1, 7, 28, 84, 210, 462, 924]; c = [7, -21, 35, -35, 21, -7, 1]);
    if (sd == 7, x_ini = [1, 8, 36, 120, 330, 792, 1716, 3432]; c = [8, -28, 56, -70, 56, -28, 8, -1]);
    if (sd == 8, x_ini = [1, 9, 45, 165, 495, 1287, 3003, 6435, 12870]; c = [9, -36, 84, -126, 126, -84, 36, -9, 1]);
    if (sd == 9, x_ini = [1, 10, 55, 220, 715, 2002, 5005, 11440, 24310, 48620]; c = [10, -45, 120, -210, 252, -210, 120, -45, 10, -1]);
    if (sd == 10, x_ini = [0, 9, 63, 282, 996, 2997, 8001, 19440, 43749, 92368, 184745]; c = [11, -55, 165, -330, 462, -462, 330, -165, 55, -11, 1]);
    return(gen_lr(x_ini, c, nd));
}


/*
sum of numbers with number of digits = nd and sum of digits = sd
nd >= 1, 0 <= sd <= 10
*/
fs(nd, sd, m) = {
    my(x_ini, c);
    if (sd == 0, return(Mod(0, m)));
    if (sd == 1, x_ini = [1, 11]; c = [11, -10]);
    if (sd == 2, x_ini = [2, 33, 444, 5555]; c = [22, -141, 220, -100]);
    if (sd == 3, x_ini = [3, 66, 1110, 16665, 233331, 3111108]; c = [33, -393, 1991, -3930, 3300, -1000]);
    if (sd == 4, x_ini = [4, 110, 2220, 38885, 622216, 9333324, 133333320, 1833333315]; c = [44, -766, 6644, -29761, 66440, -76600, 44000, -10000]);
    if (sd == 5, x_ini = [5, 165, 3885, 77770, 1399986, 23333310, 366666630, 5499999945, 79444444365, 1112222222111]; c = [55, -1260, 15510, -110505, 460251, -1105050, 1551000, -1260000, 550000, -100000]);
    if (sd == 6, x_ini = [6, 231, 6216, 139986, 2799972, 51333282, 879999912, 14299999857, 222444444222, 3336666666333, 48533333332848, 687555555554868]; c = [66, -1875, 29920, -293715, 1830906, -7272861, 18309060, -29371500, 29920000, -18750000, 6600000, -1000000]);
    if (sd == 7, x_ini = [7, 308, 9324, 233310, 5133282, 102666564, 1906666476, 33366666333, 556111110555, 8897777776888, 137511111109736, 2062666666664604, 30146666666663652, 430666666666662360]; c = [77, -2611, 51205, -641585, 5360971, -30349977, 116619591, -303499770, 536097100, -641585000, 512050000, -261100000, 77000000, -10000000]);
    if (sd == 8, x_ini = [8, 396, 13320, 366630, 8799912, 190666476, 3813332952, 71499999285, 1271111109840, 21608888886728, 353599999996464, 5598666666661068, 86133333333324720, 1291999999999987080, 18949333333333314384, 272396666666666639427]; c = [99, -4446, 119724, -2153286, 27277866, -250281024, 1686485196, -8392049649, 30869546411, -83920496490, 168648519600, -250281024000, 272778660000, -215328600000, 119724000000, -44460000000]; c = [88, -3468, 80696, -1230950, 12930456, -95736508, 504079048, -1889815041, 5040790480, -9573650800, 12930456000, -12309500000, 8069600000, -3468000000, 880000000, -100000000]);
    if (sd == 9, x_ini = [9, 495, 18315, 549945, 14299857, 333666333, 7149999285, 142999998570, 2701111108410, 48619999995138, 839799999991602, 13996666666652670, 226099999999977390, 3552999999999964470, 54479333333333278854, 817189999999999918281, 12017499999999999879825, 173586111111111110937525]; c = [99, -4446, 119724, -2153286, 27277866, -250281024, 1686485196, -8392049649, 30869546411, -83920496490, 168648519600, -250281024000, 272778660000, -215328600000, 119724000000, -44460000000, 9900000000, -1000000000]);
    if (sd == 10, x_ini = [0, 495, 23310, 783255, 22133112, 554999445, 12699998730, 269999997300, 5401111105710, 102631111100848, 1866111111092450, 32657777777745120, 552677777777722510, 9079777777777686980, 145277111111110965834, 2269961111111110884115, 34717111111111110763940, 520757222222222221701465, 7674322222222222221454790, 111277722222222222221109445]; c = [110, -5545, 169620, -3514710, 52161252, -571870410, 4712355120, -29446197045, 140046944510, -507406003501, 1400469445100, -2944619704500, 4712355120000, -5718704100000, 5216125200000, -3514710000000, 1696200000000, -554500000000, 110000000000, -10000000000]);
    return(gen_lr_mod(x_ini, c, nd, m));
}


S(n) = {
    my(nrest, sdrest, x, s, posmax, pos_l, pos_h, pos, dpos, t, xd);
    nrest = n; sdrest = 10;
    x = 0; s = 0;
    posmax = 1; while (fc(posmax, sdrest) < nrest, posmax *= 2);
    while (sdrest > 0,
        /*pos = 1; while (fc(pos, sdrest) < nrest, pos++);*/
        pos_l = 1; pos_h = posmax;
        while (pos_l <= pos_h,
            pos = (pos_l + pos_h) \ 2;
            if (pos_l == pos_h, break);
            if (fc(pos, sdrest) < nrest,
                pos_l = pos + 1,
                if (pos == 1 || fc(pos - 1, sdrest) < nrest,
                    break,
                    pos_h = pos - 1;
                );
            );
        );
        if (pos == 1,
            dpos = sdrest,
            for (d = 0, min(9, nrest),
                dpos = d;
                t = fc(pos-1, sdrest-d);
                if (t >= nrest,
                    break,
                    nrest -= t;
                    xd = x + d*Mod(10, M)^(pos-1);
                    s += fs(pos-1, sdrest-d, M) + xd * t;
                );
            );
        );
        sdrest -= dpos;
        x += dpos * Mod(10, M)^(pos-1);
        if (sdrest == 0, s += x);
        posmax = pos - 1;
    );
    return(s);
}


{
M = 10^18+3;
res = 0;
for (i = 1, 100,
    print("i = ", i);
    res += S(11^i);
);
print(lift(res));
}
